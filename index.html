<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RiverVill PD - Terminal 2.9</title>
    <style>
        :root {
            --win-gray: #c0c0c0;
            --win-dark: #808080;
            --win-blue: #000080;
            --term-green: #33ff33;
            --rage-red: #ff4444;
            --ui-accent: rgba(51, 255, 51, 0.15);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', monospace; overflow: hidden; }

        /* CRT & GLITCH EFFECTS */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 9999; background-size: 100% 3px, 3px 100%; pointer-events: none; opacity: 0.4;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            25% { transform: translate(-1px, -1px); }
            50% { transform: translate(-2px, 1px); }
            75% { transform: translate(1px, -1px); }
            100% { transform: translate(0, 0); }
        }
        .rage-text { color: var(--rage-red) !important; display: inline-block; animation: shake 0.15s infinite; font-weight: bold; text-shadow: 0 0 5px var(--rage-red); }

        /* OS INTERFACE */
        #boot-screen { position: fixed; width: 100%; height: 100%; background: #050505; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; color: var(--term-green); }
        .boot-box { border: 2px solid var(--term-green); padding: 40px; background: #000; text-align: center; }
        .boot-btn { background: transparent; color: var(--term-green); border: 1px solid var(--term-green); padding: 10px 25px; margin: 10px; cursor: pointer; font-family: inherit; font-weight: bold; }
        .boot-btn.selected { background: var(--term-green); color: #000; }
        #start-btn { margin-top: 30px; display: none; border-width: 3px; }

        #os-interface { display: none; height: 100%; flex-direction: column; }
        #top-bar { background: var(--win-gray); border-bottom: 2px solid var(--win-dark); color: #000; padding: 5px 15px; display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; }
        #desktop { flex-grow: 1; background: #3a6ea5; position: relative; }
        
        .desktop-icon { width: 90px; margin: 20px; text-align: center; color: white; cursor: pointer; font-size: 12px; }
        .icon-pic { font-size: 45px; margin-bottom: 8px; display: block; }

        .window { position: absolute; background: var(--win-gray); border: 2px solid #fff; border-right: 2px solid var(--win-dark); border-bottom: 2px solid var(--win-dark); display: none; flex-direction: column; z-index: 100; }
        .title-bar { background: var(--win-blue); color: white; padding: 4px 8px; display: flex; justify-content: space-between; font-size: 12px; }
        .close-btn { background: var(--win-gray); border: 1px solid #000; cursor: pointer; padding: 0 5px; color: #000; font-weight: bold; }
        .content { padding: 20px; color: black; background: white; margin: 2px; border: 1px solid var(--win-dark); overflow-y: auto; white-space: pre-wrap; font-size: 14px; line-height: 1.6; }

        /* --- –ù–û–í–û–ï –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–û–ï –î–ò–ê–õ–û–ì–û–í–û–ï –û–ö–ù–û --- */
        #dialog-box {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 850px; height: 180px; background: rgba(5, 10, 5, 0.95);
            border: 2px solid #333; border-top: 4px solid var(--win-blue);
            color: #fff; display: none; z-index: 4500; overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }
        .dialog-layout { display: flex; height: 100%; }
        .dialog-portrait { 
            width: 150px; background: rgba(51, 255, 51, 0.05); border-right: 1px solid #222;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .wave-container { display: flex; align-items: flex-end; height: 40px; gap: 3px; }
        .wave-bar { width: 4px; background: var(--term-green); animation: wave 0.5s infinite ease-in-out; }
        @keyframes wave { 
            0%, 100% { height: 5px; opacity: 0.3; } 
            50% { height: 30px; opacity: 1; } 
        }

        .dialog-main { flex: 1; padding: 15px; position: relative; }
        .dialog-header { font-size: 10px; color: #666; display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .dialog-name { color: var(--term-green); font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .dialog-text { font-size: 15px; line-height: 1.4; letter-spacing: 0.5px; }
        
        .dialog-ok { 
            position: absolute; bottom: 15px; right: 15px; background: transparent; 
            border: 1px solid var(--term-green); color: var(--term-green); 
            cursor: pointer; padding: 5px 15px; font-size: 11px; text-transform: uppercase;
        }
        .dialog-ok:hover { background: var(--term-green); color: #000; }

        #room-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; }
    </style>
</head>
<body>

<div class="crt-overlay"></div>

<div id="boot-screen">
    <div class="boot-box">
        <h1 style="letter-spacing: 3px;">RIVERVILL SYSTEM v2.9</h1>
        <p>–Ø–ó–´–ö / LANGUAGE</p>
        <button class="boot-btn" id="lang-ru" onclick="selectLang('ru')">–†–£–°–°–ö–ò–ô</button>
        <button class="boot-btn" id="lang-en" onclick="selectLang('en')">ENGLISH</button>
        <p>–†–ï–ñ–ò–ú / MODE</p>
        <button class="boot-btn" id="diff-novice" onclick="selectDiff('Novice')">–ù–û–í–ò–ß–ï–ö</button>
        <button class="boot-btn" id="diff-story" onclick="selectDiff('Story')">STORY MODE</button>
        <br>
        <button class="boot-btn" id="start-btn" onclick="startGame()">–í–û–ô–¢–ò –í –ü–£–°–¢–û–¢–£ / ENTER VOID</button>
    </div>
</div>

<div id="os-interface">
    <div id="top-bar">
        <div id="sys-info">Terminal v2.9 | User: Conor</div>
        <div id="status-text">12¬∞C | üåßÔ∏è –°–Ω–∞—Ä—É–∂–∏ –≤—Å—ë —Å–ø–æ–∫–æ–π–Ω–æ...</div>
    </div>
    <div id="desktop">
        <div style="display: flex; flex-direction: column;">
            <div class="desktop-icon" onclick="openWin('mail-win')"><span class="icon-pic">üì¨</span><span id="label-mail">–ü–æ—á—Ç–∞</span></div>
            <div class="desktop-icon" onclick="openWin('archive-win')"><span class="icon-pic">üóÑÔ∏è</span><span id="label-archive">–ê—Ä—Ö–∏–≤</span></div>
        </div>
        <button id="stand-btn" onclick="enterRoom()" style="position: absolute; bottom: 20px; right: 20px; padding: 10px; cursor: pointer; font-family: inherit;">–í–°–¢–ê–¢–¨ (STAND UP)</button>

        <div id="mail-win" class="window" style="width: 580px; left: 80px; top: 40px;">
            <div class="title-bar"><span id="title-mail">Inbound_Mail</span><button class="close-btn" onclick="closeWin('mail-win', true)">X</button></div>
            <div class="content" style="height: 400px;" id="mail-body"></div>
        </div>

        <div id="archive-win" class="window" style="width: 520px; left: 160px; top: 100px;">
            <div class="title-bar"><span id="title-archive">Archive_L1</span><button class="close-btn" onclick="closeWin('archive-win')">X</button></div>
            <div id="archive-body" class="content" style="height: 400px;"></div>
        </div>
    </div>
    
    <div id="dialog-box">
        <div class="dialog-layout">
            <div class="dialog-portrait">
                <div style="font-size: 10px; margin-bottom: 10px;">ID: CONOR_01</div>
                <div class="wave-container">
                    <div class="wave-bar" style="animation-delay: 0.1s"></div>
                    <div class="wave-bar" style="animation-delay: 0.3s"></div>
                    <div class="wave-bar" style="animation-delay: 0.2s"></div>
                    <div class="wave-bar" style="animation-delay: 0.4s"></div>
                    <div class="wave-bar" style="animation-delay: 0.1s"></div>
                </div>
                <div style="font-size: 9px; margin-top: 10px; color: #444;">SIGNAL: STABLE</div>
            </div>
            <div class="dialog-main">
                <div class="dialog-header">
                    <span id="dialog-meta-id">LOCAL_COMMS_049</span>
                    <span id="dialog-timestamp">21:44:02</span>
                </div>
                <div class="dialog-name" id="dialog-sender-name">–ö–û–ù–û–†:</div>
                <div class="dialog-text" id="dialog-text"></div>
                <button class="dialog-ok" id="btn-dialog-close" onclick="hideDialog()">–ó–ê–ö–†–´–¢–¨ [X]</button>
            </div>
        </div>
    </div>
</div>

<div id="room-view">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
    let currentLang = 'ru';
    let currentDiff = null;
    let mailOpened = false;

    const data = {
        ru: {
            mail_label: "–ü–æ—á—Ç–∞", archive_label: "–ê—Ä—Ö–∏–≤", stand_btn: "–í–°–¢–ê–¢–¨ –ò–ó-–ó–ê –°–¢–û–õ–ê", dialog_close: "–ü–†–û–î–û–õ–ñ–ò–¢–¨ [X]",
            cmd_full: "–ó–¥–æ—Ä–æ–≤–æ, –Ω–æ–≤–∏—á–æ–∫. –ü—è–ª–∏—à—å—Å—è –≤ –º–æ–Ω–∏—Ç–æ—Ä? –ú–æ–ª–æ–¥–µ—Ü, —Ö–æ—Ç—å –∫—Ç–æ-—Ç–æ –¥–µ–ª–∞–µ—Ç –≤–∏–¥, —á—Ç–æ –Ω–∞–º –Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ. –Ø —Ç–≤–æ–π –∫–æ–º–∞–Ω–¥–∏—Ä, –∏ –º–æ—è —Ä–∞–±–æ—Ç–∞ ‚Äî –≤–±–∏—Ç—å –≤ —Ç–≤–æ—é –≥–æ–ª–æ–≤—É —Ö–æ—Ç—å –∫–∞–ø–ª—é –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–æ–≥–æ, –≤ –∫–∞–∫–æ–µ –¥–µ—Ä—å–º–æ —Ç—ã –≤–ª—è–ø–∞–ª—Å—è. \n\n–†–∞–∑–≥—Ä–µ–±–∞–π —ç—Ç–æ –¥–µ—Ä—å–º–æ —Å –õ–∏–∑–æ–π –°–∏–Ω. –í—Å–µ–º –Ω–∞–≤–µ—Ä—Ö—É –ø–ª–µ–≤–∞—Ç—å, –æ–Ω–∏ —Ö–æ—Ç—è—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –≤ –æ—Ç—á–µ—Ç–∞—Ö. –ù–æ —è-—Ç–æ –∑–Ω–∞—é, —á—Ç–æ —Ç—ã ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤ —ç—Ç–æ–º —Å—Ä–∞–Ω–æ–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–µ, –∫–æ–º—É –µ—â–µ –Ω–µ –ª–µ–Ω—å –∫–æ–ø–∞—Ç—å. –ù–∞–π–¥–∏ –µ—ë, –ö–æ–Ω–æ—Ä. –ü—Ä–æ—Å—Ç–æ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–µ —Å–¥–æ—Ö–Ω—É—Ç—å, –ª–∞–¥–Ω–æ? –ê —Ç–æ –æ—Ç—á–µ—Ç—ã –ø–∏—Å–∞—Ç—å –±—É–¥–µ—Ç –Ω–µ–∫–æ–º—É. –£–¥–∞—á–∏, –º–∞—Ç—å –µ—ë.",
            lisa_mail: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞... –Ø –ø–∏—à—É —ç—Ç–æ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–∫–∞—Ñ–µ, —É –º–µ–Ω—è –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏. –ú–æ—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è X-Network... –æ–Ω–∏ –Ω–µ —É—á–µ–Ω—ã–µ, –æ–Ω–∏ –≥—Ä–µ–±–∞–Ω—ã–µ –º—è—Å–Ω–∏–∫–∏. –¢–≤–æ—Ä—è—Ç —Ç–∞–∫–æ–µ, –æ —á–µ–º –Ω–µ –ø–∏—à—É—Ç –≤ –≥–∞–∑–µ—Ç–∞—Ö. –Ø –±–æ—é—Å—å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –¥–æ–º–æ–π. \n\n–Ø –∑–≤–æ–Ω–∏–ª–∞ –≤ –ø–æ–ª–∏—Ü–∏—é —Ç—Ä–∏–∂–¥—ã, –∏ –¥–µ–∂—É—Ä–Ω—ã–π –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–µ—è–ª—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –µ—Å–ª–∏ –≤ —ç—Ç–æ–º –ø–∞—Ä—à–∏–≤–æ–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–µ –æ—Å—Ç–∞–ª—Å—è —Ö–æ—Ç—å –æ–¥–∏–Ω –∂–∏–≤–æ–π –º–µ–Ω—Ç ‚Äî –ø–æ–º–æ–≥–∏—Ç–µ –º–Ω–µ! –Ø –Ω–µ —Ö–æ—á—É –ø—Ä–æ—Å—Ç–æ –∏—Å—á–µ–∑–Ω—É—Ç—å –≤ –ø—É—Å—Ç–æ—Ç–µ. (–°—Ç–∞—Ç—É—Å: –ü—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ)",
            case_full: "–û–ë–™–ï–ö–¢: –õ–∏–∑–∞ –°–∏–Ω, 24 –≥–æ–¥–∞. \n\n–í–≤—è–∑–∞–ª–∞—Å—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã X-Network, –∏ —Å —Ç–µ—Ö –ø–æ—Ä –≤—Å—ë –ø–æ—à–ª–æ –ø–æ –ø–∏–∑... –ø–æ –Ω–∞–∫–ª–æ–Ω–Ω–æ–π. –í—ã—à–ª–∞ –∏–∑ –∑–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ –∏ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Ç–≤–æ—Ä–∏–ª–∞—Å—å –≤ –≤–æ–∑–¥—É—Ö–µ. –í –≥–æ—Ä–æ–¥–µ —à–µ–ø—á—É—Ç—Å—è, —á—Ç–æ –µ—ë –≤–∏–¥–µ–ª–∏ –≤ —Ç–µ–Ω—è—Ö, –∏ –ø–æ—Å–ª–µ —ç—Ç–∏—Ö –≤—Å—Ç—Ä–µ—á –Ω–∞—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ —Ç—Ä—É–ø—ã. \n\n–ö–æ–Ω–æ—Ä, –±—É–¥–µ–º —á–µ—Å—Ç–Ω—ã: –Ω–∞ —Ç–µ–±—è —ç—Ç–æ –¥–µ–ª–æ —Å–ø–∏—Ö–Ω—É–ª–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç–∞—Ä–∏–∫–∏ –∑–Ω–∞—é—Ç ‚Äî —ç—Ç–æ –≥–∏–±–ª–æ–µ –º–µ—Å—Ç–æ. –ó–¥–µ—Å—å –≤—Å—ë –≤–æ–Ω—è–µ—Ç –≤—Ä–∞–Ω—å–µ–º –∏ –±–µ–∑—Ä–∞–∑–ª–∏—á–∏–µ–º. –í–Ω–∏–∫–∞–π –≤ —á–µ—Ä—Ç–æ–≤—ã —Ñ–∞–π–ª—ã, –Ω–æ –Ω–µ –¥–∞–π —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ª–µ–∑—Ç—å —Ç–µ–±–µ –≤ –≥–æ–ª–æ–≤—É. –ï—Å–ª–∏ —Ç—ã –ø—Ä–æ–ø–∞–¥–µ—à—å, –≥–æ—Ä–æ–¥ –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç.",
            start_msg: "–ò —Ç–∞–∫... –ø–æ—Ä–∞ –∑–∞–Ω—è—Ç—å—Å—è —ç—Ç–∏–º... –¥–µ–ª–æ–º? –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –≤—Å—ë –±—É–¥–µ—Ç –≤ –ø–æ—Ä—è–¥–∫–µ... –•–æ—Ç—è –∫–æ–≥–æ —è –æ–±–º–∞–Ω—ã–≤–∞—é? –í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ ¬´–≤ –ø–æ—Ä—è–¥–∫–µ¬ª –±—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —É —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –≤ –º–æ—Ä–≥–µ.",
            rage_msg: "–í–æ—Ç –∂–µ —Å—É–∫–∞... –¢–æ –µ—Å—Ç—å –æ–Ω–∏ –º–µ–Ω—è <span class='rage-text'>–ù–ê –°–ú–ï–†–¢–¨</span> —Å —ç—Ç–æ–π –õ–∏–∑–æ–π –ø–æ—Å—ã–ª–∞—é—Ç?! –ü–æ–∫–∞ –≤—Å–µ —ç—Ç–∏ –∂–∏—Ä–Ω—ã–µ –∫–æ—Ç—ã –≤ –º—ç—Ä–∏–∏ –∂—Ä—É—Ç —Å–≤–æ–∏ —Å—Ç–µ–π–∫–∏, —è –¥–æ–ª–∂–µ–Ω —Å–¥–æ—Ö–Ω—É—Ç—å –≤ –∫–∞–∫–æ–π-—Ç–æ –ø–æ–¥–≤–æ—Ä–æ—Ç–Ω–µ?! –ù–µ–µ, –Ω—É —Ç–∞–∫ –Ω–µ –ø–æ–π–¥—ë—Ç... –Ø —ç—Ç–æ –¥–µ–ª–æ —Ä–∞–∑–≥—Ä–µ–±—É –∏ —ç—Ç—É <span class='rage-text'>–ß–ï–†–¢–û–í–£ –í–ï–†–•–£–®–ö–£ –†–ê–°–•–£–Ø–ß–£!</span> –û–Ω–∏ –µ—â–µ —É–∑–Ω–∞—é—Ç, —á—Ç–æ –ö–æ–Ω–æ—Ä —É–º–µ–µ—Ç –∫—É—Å–∞—Ç—å—Å—è!"
        },
        en: {
            mail_label: "Mail", archive_label: "Archive", stand_btn: "STAND UP", dialog_close: "CONTINUE [X]",
            cmd_full: "Hey, rookie. Staring at the screen? Good. At least someone's pretending to care. \n\nDeal with this Lisa Sin crap. High-ups don't care. But I know you're the only one in this shitty department who's still willing to dig. Find her, Conor. Try not to die, okay? Good luck, damn it.",
            lisa_mail: "Please... X-Network labs... they are butchers. I'm scared to go home. \n\nI called the PD thrice, and the officer just laughed. Please, if there's one real cop left ‚Äî help me! I don't want to just vanish. (Status: Ignored)",
            case_full: "SUBJECT: Lisa Sin, 24.\n\nJoined X-Network experiments, then vanished. Rumors say she's lurking in the shadows, leaving corpses behind.\n\nHonestly, Conor? You got this case because it's a death trap. Everything here smells like lies. Read the files, but don't let it get to you.",
            start_msg: "Well... time to get to this... case? Hope everything will be fine... But who am I kidding? In this city, 'fine' is only for those in the morgue.",
            rage_msg: "Son of a bitch... So they're sending me to <span class='rage-text'>MY DEATH</span>?! While those fat cats eat their steaks, I'm supposed to die in some alley?! No way... I'll solve this and <span class='rage-text'>FUCK UP THAT DAMN LEADERSHIP!</span>"
        }
    };

    function selectLang(l) { currentLang = l; document.querySelectorAll('.boot-btn[id^="lang-"]').forEach(b => b.classList.remove('selected')); document.getElementById('lang-' + l).classList.add('selected'); checkStart(); }
    function selectDiff(d) { currentDiff = d; document.querySelectorAll('.boot-btn[id^="diff-"]').forEach(b => b.classList.remove('selected')); document.getElementById('diff-' + d.toLowerCase()).classList.add('selected'); checkStart(); }
    function checkStart() { if(currentLang && currentDiff) document.getElementById('start-btn').style.display = 'inline-block'; }

    function startGame() {
        const l = data[currentLang];
        document.getElementById('boot-screen').style.display = 'none';
        document.getElementById('os-interface').style.display = 'flex';
        document.getElementById('label-mail').innerText = l.mail_label;
        document.getElementById('label-archive').innerText = l.archive_label;
        document.getElementById('stand-btn').innerText = l.stand_btn;
        document.getElementById('btn-dialog-close').innerText = l.dialog_close;
        document.getElementById('dialog-sender-name').innerText = (currentLang === 'ru' ? "–ö–û–ù–û–†:" : "CONOR:");
        document.getElementById('mail-body').innerHTML = `<strong>FROM: Commander</strong><br>${l.cmd_full}<hr><strong style="color:red">FROM: Lisa Sin</strong><br>${l.lisa_mail}`;
        document.getElementById('archive-body').innerHTML = `<strong>CASE_REPORT</strong><br><br>${l.case_full}`;
        setTimeout(() => { showDialog(l.start_msg); }, 1000);
    }

    // –¢–ò–ü–ò–ó–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê
    function showDialog(text) {
        const box = document.getElementById('dialog-box');
        const textElem = document.getElementById('dialog-text');
        box.style.display = 'block';
        textElem.innerHTML = "";
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        document.getElementById('dialog-timestamp').innerText = new Date().toLocaleTimeString();

        let i = 0;
        function type() {
            if (i < text.length) {
                // –ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ–º —Ç–µ–≥, –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º
                if(text[i] === '<') {
                    let tag = text.substring(i, text.indexOf('>', i) + 1);
                    textElem.innerHTML += tag;
                    i += tag.length;
                    // –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–µ–≥–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–µ—á–∞—Ç–∞—Ç—å
                    if(tag.includes('rage-text')) {
                        let content = text.substring(i, text.indexOf('</span>', i));
                        textElem.innerHTML += content + '</span>';
                        i += content.length + 7;
                    }
                } else {
                    textElem.innerHTML += text[i];
                    i++;
                }
                setTimeout(type, 20);
            }
        }
        type();
    }

    function hideDialog() { document.getElementById('dialog-box').style.display = 'none'; }
    function openWin(id) { document.getElementById(id).style.display = 'flex'; if(id === 'mail-win') mailOpened = true; }
    function closeWin(id, checkRage = false) { document.getElementById(id).style.display = 'none'; if(checkRage && mailOpened) { setTimeout(() => { showDialog(data[currentLang].rage_msg); }, 1000); mailOpened = false; } }

    // --- 2D ENGINE (ENHANCED OFFICE) ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let player = { x: 400, y: 500, speed: 6, frame: 0 };
    let keys = {};

    window.onkeydown = (e) => { keys[e.key.toLowerCase()] = true; if((e.key === 'e' || e.key === '—É') && player.y > 450) exitRoom(); };
    window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

    function enterRoom() {
        document.getElementById('os-interface').style.display = 'none';
        document.getElementById('room-view').style.display = 'block';
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        requestAnimationFrame(gameLoop);
    }
    function exitRoom() { document.getElementById('room-view').style.display = 'none'; document.getElementById('os-interface').style.display = 'flex'; }

    function gameLoop() {
        if(document.getElementById('room-view').style.display === 'none') return;
        if(keys['w'] || keys['—Ü']) player.y -= player.speed;
        if(keys['s'] || keys['—ã']) player.y += player.speed;
        if(keys['a'] || keys['—Ñ']) player.x -= player.speed;
        if(keys['d'] || keys['–≤']) player.x += player.speed;
        player.frame += 0.05;

        ctx.fillStyle = "#0a0a0c"; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        // Window
        ctx.fillStyle = "#001020"; ctx.fillRect(canvas.width/2 - 150, 50, 300, 150);
        ctx.strokeStyle = "rgba(100, 150, 255, 0.3)";
        for(let i=0; i<15; i++) {
            let rx = (canvas.width/2 - 150) + (Math.random()*300), ry = 50 + (Math.random()*150);
            ctx.beginPath(); ctx.moveTo(rx, ry); ctx.lineTo(rx-5, ry+10); ctx.stroke();
        }

        // Desk
        ctx.fillStyle = "#1a1a1a"; ctx.fillRect(canvas.width/2 - 100, 500, 200, 100);
        ctx.fillStyle = "#051505"; ctx.fillRect(canvas.width/2 - 35, 485, 70, 40); // Monitor
        
        // Character
        let breath = Math.sin(player.frame*2.5)*2;
        ctx.fillStyle = "#d2b48c"; ctx.fillRect(player.x, player.y+breath, 40, 40);
        ctx.fillStyle = "#3e2723"; ctx.fillRect(player.x, player.y+25+breath, 40, 15);
        
        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>
